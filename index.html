<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>H & K</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="H & K">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  height:100vh;
  display:flex;
  flex-direction:column;
  color:white;
  background:#0f2027;
}

header{
  text-align:center;
  padding:14px;
  font-weight:600;
  background:rgba(11,26,32,0.9);
}

#chat{
  flex:1;
  overflow-y:auto;
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.msg{
  background:#203a43;
  padding:10px 14px;
  border-radius:18px;
  max-width:75%;
  position:relative;
}

.me{
  background:#2c5364;
  align-self:flex-end;
}

.reply-preview{
  font-size:12px;
  opacity:0.7;
  border-left:3px solid #ff8fb1;
  padding-left:6px;
  margin-bottom:6px;
}

.name{
  font-size:11px;
  font-weight:600;
  margin-bottom:4px;
}

.meta{
  font-size:10px;
  opacity:0.6;
  margin-top:4px;
  text-align:right;
}

#replyBar{
  display:none;
  padding:6px 10px;
  background:#162b33;
  font-size:12px;
}

#bar{
  display:flex;
  gap:8px;
  padding:10px;
  background:#0b1a20;
}

#msg{
  flex:1;
  padding:12px 16px;
  border-radius:22px;
  border:none;
  outline:none;
  font-size:16px;
}

button{
  padding:10px 18px;
  border-radius:22px;
  border:none;
  background:#ff8fb1;
}
</style>
</head>

<body>

<header>ðŸ’— H & K</header>

<div id="chat"></div>

<div id="replyBar"></div>

<div id="bar">
  <input id="msg" placeholder="Messageâ€¦" autocomplete="off">
  <button onclick="send()">Send</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyB0FpYJytVZuHjtHjL5-RDK1MlIEEi6K6c",
  authDomain:"private-chat-4f4b9.firebaseapp.com",
  projectId:"private-chat-4f4b9"
});
const db=firebase.firestore();

/* USER */
let username=localStorage.getItem("chat_name");
if(!username){
  username=prompt("Your name?");
  localStorage.setItem("chat_name",username);
}

/* READ RECEIPT */
db.collection("meta").doc("seen").set({
  [username]: Date.now()
},{merge:true});

/* REPLY STATE */
let replyingTo=null;

function send(){
  const text=msg.value.trim();
  if(!text)return;

  db.collection("messages").add({
    name:username,
    text,
    reply:replyingTo,
    time:Date.now()
  });

  msg.value="";
  replyingTo=null;
  replyBar.style.display="none";
}

/* RENDER */
db.collection("messages").orderBy("time").onSnapshot(snap=>{
  chat.innerHTML="";
  snap.forEach(doc=>{
    const m=doc.data();
    const div=document.createElement("div");
    div.className="msg"+(m.name===username?" me":"");

    if(m.reply){
      const r=document.createElement("div");
      r.className="reply-preview";
      r.textContent=`${m.reply.name}: ${m.reply.text}`;
      div.appendChild(r);
    }

    const n=document.createElement("div");
    n.className="name";
    n.textContent=m.name;
    div.appendChild(n);

    div.appendChild(document.createTextNode(m.text));

    const meta=document.createElement("div");
    meta.className="meta";
    const time=new Date(m.time).toLocaleTimeString([],{
      hour:"2-digit",minute:"2-digit"
    });
    meta.textContent=time + (m.name===username?" âœ“âœ“":"");
    div.appendChild(meta);

    div.onclick=()=>{
      replyingTo={name:m.name,text:m.text};
      replyBar.style.display="block";
      replyBar.textContent=`Replying to ${m.name}: ${m.text}`;
      msg.focus();
    };

    chat.appendChild(div);
  });
  chat.scrollTop=chat.scrollHeight;
});
</script>

</body>
</html>
