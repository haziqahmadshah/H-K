<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>H & K</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">

    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="H & K">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        /* ========================================
           CSS VARIABLES & GLOBAL STYLES
           ========================================
        */
        :root {
            --primary-bg: #0f2027;
            --header-bg: rgba(11, 26, 32, 0.95);
            --pink-accent: #ff8fb1;
            --blue-accent: #4fc3ff;
            --msg-me-bg: #2c5364;
            --msg-them-bg: #203a43;
            --input-bg: #1e272e;
            --bar-bg: #0b1a20;
            --soft-pink: #f8a5c2;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
            background: var(--primary-bg);
            background-attachment: fixed;
            overflow: hidden; /* Prevent body scroll, use #chat scroll instead */
        }

        /* SUBTLE BLUR EFFECT ON BACKGROUND 
           Restored strictly from baseline.
        */
        body::before {
            content: "";
            position: fixed;
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Ctext x='30' y='60' font-size='24' fill='rgba(255,140,160,0.12)'%3E‚ù§%3C/text%3E%3Ctext x='110' y='130' font-size='20' fill='rgba(255,140,160,0.1)'%3E‚ù§%3C/text%3E%3C/svg%3E");
            background-repeat: repeat;
            filter: blur(1.5px);
            z-index: -1;
        }

        /* ========================================
           HEADER STYLES
           ========================================
        */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            font-weight: 600;
            background: var(--header-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        header span {
            flex: 1;
            text-align: center;
            color: var(--pink-accent);
            text-shadow: 0 0 10px rgba(255, 143, 177, 0.3);
            font-size: 18px;
            letter-spacing: 0.5px;
        }

        .presence {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            width: 70px;
            transition: opacity 0.3s ease;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            opacity: 0.3;
            margin-bottom: 3px;
            transition: all 0.3s ease;
        }

        .dot.blue { background: var(--blue-accent); }
        .dot.pink { background: var(--pink-accent); }
        
        .dot.online {
            opacity: 1;
            box-shadow: 0 0 6px currentColor, 0 0 12px currentColor;
        }
        
        .dot.idle { opacity: 0.6; }

        /* ========================================
           CHAT AREA STYLES
           ========================================
        */
        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* Day Separator */
        .day {
            align-self: center;
            font-size: 12px;
            opacity: 0.6;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ========================================
           MESSAGE BUBBLE STYLES
           ========================================
        */
        .msg {
            background: var(--msg-them-bg);
            padding: 12px 16px 8px;
            border-radius: 18px;
            max-width: 75%;
            align-self: flex-start;
            position: relative;
            color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
            cursor: pointer;
        }

        .msg:active { transform: scale(0.98); }

        .me {
            background: var(--msg-me-bg);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .them { border-bottom-left-radius: 4px; }

        .name {
            font-size: 11px;
            margin-bottom: 4px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .name.blue { color: var(--blue-accent); }
        .name.pink { color: var(--pink-accent); }

        /* Message Text */
        .text-wrap {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.4;
        }

        /* Image styling in chat */
        .img {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 8px;
            display: block;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        /* Reply Preview inside bubble */
        .reply-preview {
            border-left: 3px solid var(--pink-accent);
            padding: 6px 10px;
            margin-bottom: 8px;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 4px;
            opacity: 0.9;
            font-style: italic;
        }

        /* ========================================
           READ RECEIPTS & TIME STYLES
           ========================================
        */
        .time-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
            margin-top: 6px;
        }

        .time {
            font-size: 10px;
            opacity: 0.5;
        }

        /* READ RECEIPTS SYSTEM */
        .status {
            font-size: 12px;
            line-height: 1;
            display: none; /* Only show for "me" messages */
            transition: color 0.3s ease;
        }

        .me .status { display: inline-block; }
        
        .status.read { 
            color: var(--blue-accent);
            text-shadow: 0 0 5px rgba(79, 195, 255, 0.4);
        }
        
        .status.sent { 
            color: rgba(255, 255, 255, 0.25); 
        }

        /* ========================================
           REACTIONS STYLES
           ========================================
        */
        .reaction-strip {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .reaction-chip {
            background: rgba(255, 255, 255, 0.12);
            padding: 3px 9px;
            border-radius: 14px;
            font-size: 13px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .actions {
            display: none;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .reaction-picker {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .reaction-picker span {
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .reaction-picker span:hover { transform: scale(1.3); }

        .reply-btn {
            font-size: 12px;
            opacity: 0.8;
            cursor: pointer;
            text-align: center;
            padding: 6px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            font-weight: 600;
        }

        /* ========================================
           INPUT & BOTTOM BAR STYLES
           ========================================
        */
        #replyBar {
            display: none;
            padding: 10px 16px;
            background: rgba(255, 143, 177, 0.18);
            font-size: 13px;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(255, 143, 177, 0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        #replyBar b { color: var(--pink-accent); }

        #typing {
            font-size: 12px;
            opacity: 0.6;
            padding: 6px 16px;
            min-height: 18px;
            font-style: italic;
        }

        /* PILL INPUT - MATCHED TO SCREENSHOT */
        #bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: var(--bar-bg);
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            z-index: 100;
        }

        #msg {
            flex: 1;
            background: var(--input-bg);
            color: #ffffff;
            border: none;
            border-radius: 40px;
            padding: 12px 20px;
            font-size: 16px;
            outline: none;
            resize: none;
            min-height: 24px;
            max-height: 140px;
            transition: all 0.2s ease;
        }

        #msg::placeholder {
            color: #a4b0be;
            opacity: 0.7;
        }

        .icon {
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: opacity 0.2s ease;
        }

        .icon:active { opacity: 0.6; }

        button {
            background: var(--soft-pink);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 10px 22px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }

        button:active {
            transform: translateY(1px);
            filter: brightness(0.9);
        }

        /* SCROLLBAR STYLING */
        #chat::-webkit-scrollbar { width: 4px; }
        #chat::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
    </style>
</head>

<body>

    <header id="app-header">
        <div class="presence">
            <div id="dot-h" class="dot blue"></div>
            <div id="last-h">offline</div>
        </div>

        <span>üíó H & K</span>

        <div class="presence">
            <div id="dot-k" class="dot pink"></div>
            <div id="last-k">offline</div>
        </div>
    </header>

    <div id="chat" role="log"></div>

    <div id="typing"></div>

    <div id="replyBar">
        <span>Replying to <b id="replyName"></b></span>
        <span id="closeReply" style="cursor:pointer; font-size: 20px; padding: 0 5px;">‚úï</span>
    </div>

    <div id="bar">
        <span class="icon" id="imgBtn" title="Send Image">üì∑</span>
        <textarea id="msg" placeholder="Message‚Ä¶" rows="1"></textarea>
        <button id="sendBtn">Send</button>
    </div>

    <input type="file" id="imgPicker" accept="image/*" hidden>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        /**
         * ============================================================
         * HK PRIVATE CHAT CORE SCRIPT
         * Version: 4.2.0 (Read Receipts Sync Fix)
         * ============================================================
         */

        (function() {
            "use strict";

            // State Variables
            let replyData = null;
            let otherReadTime = 0;
            let currentCachedSnapshot = null;
            
            // UI References
            const chatBox = document.getElementById('chat');
            const messageInput = document.getElementById('msg');
            const sendButton = document.getElementById('sendBtn');
            const imgButton = document.getElementById('imgBtn');
            const fileInput = document.getElementById('imgPicker');
            const replyContainer = document.getElementById('replyBar');
            const replyLabel = document.getElementById('replyName');

            /**
             * 1. AUTHENTICATION & ACCESS CONTROL
             */
            const CHAT_PASSWORD = "Chingam";
            
            function authenticate() {
                if (localStorage.getItem("chat_pass") !== CHAT_PASSWORD) {
                    const passInput = prompt("Enter password:");
                    if (passInput !== CHAT_PASSWORD) {
                        document.body.innerHTML = "<div style='padding:20px; text-align:center;'>Access Denied.</div>";
                        throw new Error("Invalid Password");
                    }
                    localStorage.setItem("chat_pass", CHAT_PASSWORD);
                }
            }

            authenticate();

            // Set Username
            let username = localStorage.getItem("chat_name");
            if (!username) {
                username = prompt("Your name?") || "Unknown";
                localStorage.setItem("chat_name", username);
            }

            const allowed = ["haziq", "kaunain"];
            const isAllowed = allowed.includes(username.toLowerCase());

            if (!isAllowed) {
                messageInput.disabled = true;
                messageInput.placeholder = "Read-only mode";
                sendButton.style.display = "none";
            }

            /**
             * 2. FIREBASE INITIALIZATION
             */
            const firebaseConfig = {
                apiKey: "AIzaSyB0FpYJytVZuHjtHjL5-RDK1MlIEEi6K6c",
                authDomain: "private-chat-4f4b9.firebaseapp.com",
                projectId: "private-chat-4f4b9"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const delValue = firebase.firestore.FieldValue.delete();

            /**
             * 3. PRESENCE & READ RECEIPT TRACKING
             * Fix: Updates lastRead whenever the user is active or receiving messages
             */
            const presenceRef = db.collection("presence");
            
            function updateHeartbeat() {
                if (!isAllowed) return;
                presenceRef.doc(username).set({
                    name: username,
                    time: Date.now(),
                    lastRead: Date.now() // Signals to the other person that I've seen the chat
                }, { merge: true });
            }

            // Initial heartbeat and recurring updates
            updateHeartbeat();
            setInterval(updateHeartbeat, 5000);

            // Listen for other person's seen status
            presenceRef.onSnapshot(snapshot => {
                let hTime = null, kTime = null;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const nameLower = data.name.toLowerCase();
                    
                    if (nameLower.includes("haziq")) hTime = data.time;
                    if (nameLower.includes("kaunain")) kTime = data.time;
                    
                    // Critical Fix: Sync the other person's read time to our local state
                    if (!nameLower.includes(username.toLowerCase())) {
                        otherReadTime = data.lastRead || 0;
                        // Refresh display to turn single ticks into double blue ticks
                        if (currentCachedSnapshot) renderMessages(currentCachedSnapshot);
                    }
                });
                
                updateStatusUI("h", hTime);
                updateStatusUI("k", kTime);
            }, error => console.error("Presence sync error:", error));

            function updateStatusUI(who, time) {
                const dot = document.getElementById("dot-" + who);
                const label = document.getElementById("last-" + who);
                if (!dot || !label) return;

                dot.classList.remove("online", "idle");
                
                if (!time) {
                    label.textContent = "offline";
                    return;
                }

                const elapsed = Date.now() - time;
                if (elapsed < 8000) {
                    dot.classList.add("online");
                    label.textContent = "online";
                } else if (elapsed < 20000) {
                    dot.classList.add("idle");
                    label.textContent = "idle";
                } else {
                    const lastSeen = new Date(time);
                    label.textContent = lastSeen.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
                }
            }

            /**
             * 4. TYPING INDICATOR
             */
            messageInput.addEventListener("input", () => {
                if (!isAllowed) return;
                db.collection("typing").doc("status").set({
                    name: username,
                    time: Date.now()
                }, { merge: true });
            });

            db.collection("typing").doc("status").onSnapshot(doc => {
                if (!doc.exists) return;
                const data = doc.data();
                const typingEl = document.getElementById("typing");
                
                if (data.name !== username && (Date.now() - data.time < 3000)) {
                    typingEl.textContent = `${data.name} is typing‚Ä¶`;
                } else {
                    typingEl.textContent = "";
                }
            });

            /**
             * 5. MESSAGE RENDERING ENGINE
             * Restored baseline rendering with Read Receipt Logic
             */
            function nameClass(n) {
                const lower = (n || "").toLowerCase();
                if (lower.includes("haziq")) return "blue";
                if (lower.includes("kaunain")) return "pink";
                return "";
            }

            function isSameDay(d1, d2) {
                return d1.toDateString() === d2.toDateString();
            }

            function getDayLabel(date) {
                const now = new Date();
                const yesterday = new Date();
                yesterday.setDate(now.getDate() - 1);

                if (isSameDay(date, now)) return "Today";
                if (isSameDay(date, yesterday)) return "Yesterday";
                return date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
            }

            function renderMessages(snapshot) {
                currentCachedSnapshot = snapshot;
                const wasAtBottom = chatBox.scrollHeight - chatBox.scrollTop <= chatBox.clientHeight + 100;
                
                chatBox.innerHTML = "";
                let previousDate = null;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const timestamp = new Date(data.time);

                    // Day Separator
                    if (!previousDate || !isSameDay(previousDate, timestamp)) {
                        const dayDiv = document.createElement("div");
                        dayDiv.className = "day";
                        dayDiv.textContent = getDayLabel(timestamp);
                        chatBox.appendChild(dayDiv);
                        previousDate = timestamp;
                    }

                    // Message Container
                    const msgDiv = document.createElement("div");
                    const isMe = data.name === username;
                    msgDiv.className = `msg ${isMe ? 'me' : 'them'}`;

                    // Sender Name
                    const nameDiv = document.createElement("div");
                    nameDiv.className = "name " + nameClass(data.name);
                    nameDiv.textContent = data.name;
                    msgDiv.appendChild(nameDiv);

                    // Reply Preview (Restored baseline)
                    if (data.replyTo) {
                        const replyDiv = document.createElement("div");
                        replyDiv.className = "reply-preview";
                        replyDiv.textContent = `${data.replyTo.name}: ${data.replyTo.text}`;
                        msgDiv.appendChild(replyDiv);
                    }

                    // Text Content
                    if (data.text) {
                        const textDiv = document.createElement("div");
                        textDiv.className = "text-wrap";
                        textDiv.textContent = data.text;
                        msgDiv.appendChild(textDiv);
                    }

                    // Image Content
                    if (data.image) {
                        const imgEl = document.createElement("img");
                        imgEl.src = data.image;
                        imgEl.className = "img";
                        imgEl.loading = "lazy";
                        msgDiv.appendChild(imgEl);
                    }

                    // Reactions (Restored baseline)
                    if (data.reactions) {
                        const reactionContainer = document.createElement("div");
                        reactionContainer.className = "reaction-strip";
                        Object.values(data.reactions).forEach(emoji => {
                            const chip = document.createElement("div");
                            chip.className = "reaction-chip";
                            chip.textContent = emoji;
                            reactionContainer.appendChild(chip);
                        });
                        msgDiv.appendChild(reactionContainer);
                    }

                    // Action Panel (Hidden by default, restored baseline)
                    const actionPanel = document.createElement("div");
                    actionPanel.className = "actions";

                    if (isAllowed) {
                        const picker = document.createElement("div");
                        picker.className = "reaction-picker";
                        ["üòò", "ü§ç", "‚ù§Ô∏è", "üòÇ", "üñï", "üíÄ"].forEach(emoji => {
                            const span = document.createElement("span");
                            span.textContent = emoji;
                            span.onclick = (e) => {
                                e.stopPropagation();
                                const currentReactions = data.reactions || {};
                                if (currentReactions[username] === emoji) {
                                    doc.ref.update({ [`reactions.${username}`]: delValue });
                                } else {
                                    doc.ref.update({ [`reactions.${username}`]: emoji });
                                }
                            };
                            picker.appendChild(span);
                        });
                        actionPanel.appendChild(picker);

                        const replyAction = document.createElement("div");
                        replyAction.className = "reply-btn";
                        replyAction.textContent = "Reply";
                        replyAction.onclick = (e) => {
                            e.stopPropagation();
                            startReply(data.name, data.text || "[Media]");
                        };
                        actionPanel.appendChild(replyAction);
                    }

                    msgDiv.appendChild(actionPanel);
                    
                    // Toggle actions on click
                    msgDiv.onclick = () => {
                        const isVisible = actionPanel.style.display === "flex";
                        document.querySelectorAll('.actions').forEach(el => el.style.display = 'none');
                        actionPanel.style.display = isVisible ? "none" : "flex";
                    };

                    // Time Row & Read Receipts (Critical Fix)
                    const timeRow = document.createElement("div");
                    timeRow.className = "time-row";
                    
                    const timeDiv = document.createElement("div");
                    timeDiv.className = "time";
                    timeDiv.textContent = timestamp.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
                    
                    const receiptDiv = document.createElement("div");
                    const hasBeenRead = data.time <= otherReadTime;
                    receiptDiv.className = "status" + (hasBeenRead ? " read" : " sent");
                    receiptDiv.innerHTML = hasBeenRead ? "‚úì‚úì" : "‚úì";
                    
                    timeRow.appendChild(timeDiv);
                    timeRow.appendChild(receiptDiv);
                    msgDiv.appendChild(timeRow);

                    chatBox.appendChild(msgDiv);
                });

                if (wasAtBottom) {
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            }

            // Real-time listener for messages
            db.collection("messages").orderBy("time").onSnapshot(snapshot => {
                renderMessages(snapshot);
                // Mark messages as read upon receipt
                updateHeartbeat();
            }, error => console.error("Firestore error:", error));

            /**
             * 6. MESSAGING FUNCTIONS
             */
            function startReply(name, text) {
                replyData = { name, text: text.length > 40 ? text.substring(0, 40) + "..." : text };
                replyLabel.textContent = name;
                replyContainer.style.display = "flex";
                messageInput.focus();
            }

            function cancelReply() {
                replyData = null;
                replyContainer.style.display = "none";
            }

            document.getElementById('closeReply').onclick = cancelReply;

            function sendMessage() {
                if (!isAllowed) return;
                const text = messageInput.value.trim();
                if (!text && !replyData) return;

                const payload = {
                    name: username,
                    text: text,
                    time: Date.now()
                };

                if (replyData) {
                    payload.replyTo = replyData;
                    cancelReply();
                }

                db.collection("messages").add(payload)
                    .then(() => {
                        messageInput.value = "";
                        messageInput.style.height = 'auto';
                        messageInput.focus();
                    })
                    .catch(err => alert("Error sending: " + err.message));
            }

            sendButton.onclick = sendMessage;
            
            // Send on Enter (Shift+Enter for newline)
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            /**
             * 7. IMAGE HANDLING
             */
            imgButton.onclick = () => fileInput.click();

            fileInput.onchange = (e) => {
                if (!isAllowed) return;
                const file = e.target.files[0];
                if (!file) return;

                // Restored baseline Base64 logic
                const reader = new FileReader();
                reader.onload = () => {
                    db.collection("messages").add({
                        name: username,
                        image: reader.result,
                        time: Date.now()
                    });
                };
                reader.onerror = () => alert("Failed to read file.");
                reader.readAsDataURL(file);
                
                // Reset file input so same image can be picked twice
                fileInput.value = "";
            };

            /**
             * 8. UI POLISH
             */
            // Auto-resize textarea logic from baseline
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                const newHeight = Math.min(this.scrollHeight, 140);
                this.style.height = newHeight + 'px';
            });

        })();
    </script>
</body>
</html>
