<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>H & K</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  height:100vh;
  overflow:hidden;
  color:white;
  background:#0f2027;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Ctext x='30' y='60' font-size='22' fill='rgba(255,140,160,0.12)'%3E‚ù§%3C/text%3E%3Ctext x='110' y='130' font-size='18' fill='rgba(255,140,160,0.1)'%3E‚ù§%3C/text%3E%3C/svg%3E");
  background-repeat:repeat;
}

/* HEADER */
header{
  position:fixed;
  top:0; left:0; right:0;
  height:56px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(11,26,32,0.92);
  backdrop-filter:blur(10px);
  z-index:10;
  font-weight:600;
}

/* CHAT */
#chat{
  height:calc(100vh - 112px);
  margin-top:56px;
  padding:14px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.msg{
  background:#203a43;
  padding:10px 14px;
  border-radius:18px;
  max-width:75%;
}

.me{
  background:#2c5364;
  align-self:flex-end;
}

.name{
  font-size:11px;
  margin-bottom:4px;
  font-weight:600;
}

.name.blue{ color:#4fc3ff; }
.name.pink{ color:#ff8fb1; }

img, audio{
  max-width:100%;
  border-radius:12px;
  margin-top:6px;
}

/* INPUT BAR */
#bar{
  position:fixed;
  bottom:0; left:0; right:0;
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px;
  background:rgba(11,26,32,0.95);
}

#msg{
  flex:1;
  padding:12px 16px;
  border-radius:22px;
  border:none;
  outline:none;
  font-size:16px;
}

button{
  padding:10px 14px;
  border-radius:22px;
  border:none;
  background:#ff8fb1;
  color:#0b1a20;
  font-weight:600;
}

.icon{
  font-size:22px;
  cursor:pointer;
}
</style>
</head>

<body>

<header>üíó H & K</header>

<div id="chat"></div>

<div id="bar">
  <div class="icon" onclick="pickImage()">üì∑</div>
  <div class="icon" onclick="toggleRecord()">üé§</div>
  <input id="msg" placeholder="Message‚Ä¶" autocomplete="off">
  <button onclick="send()">Send</button>
</div>

<input type="file" id="imgPicker" accept="image/*" hidden>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* NAME */
let username = localStorage.getItem("chat_name");
if(!username){
  username = prompt("Your name?");
  localStorage.setItem("chat_name", username || "Unknown");
}

/* NAME COLOR */
function nameClass(n){
  n = n.toLowerCase();
  if(n === "haziq") return "blue";
  if(n === "kaunain") return "pink";
  return "";
}

/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyB0FpYJytVZuHjtHjL5-RDK1MlIEEi6K6c",
  authDomain:"private-chat-4f4b9.firebaseapp.com",
  projectId:"private-chat-4f4b9"
});
const db = firebase.firestore();

/* SEND TEXT */
function send(){
  const t = msg.value.trim();
  if(!t) return;
  db.collection("messages").add({
    name: username,
    text: t,
    time: Date.now()
  });
  msg.value = "";
  msg.focus();
}

/* IMAGE */
function pickImage(){ imgPicker.click(); }
imgPicker.onchange = ()=>{
  const f = imgPicker.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=> db.collection("messages").add({
    name: username,
    image: r.result,
    time: Date.now()
  });
  r.readAsDataURL(f);
};

/* AUDIO */
let rec, chunks=[], recording=false;
async function toggleRecord(){
  if(recording){ rec.stop(); recording=false; return; }
  const s = await navigator.mediaDevices.getUserMedia({audio:true});
  rec = new MediaRecorder(s);
  chunks=[];
  rec.ondataavailable = e=>chunks.push(e.data);
  rec.onstop = ()=>{
    const b = new Blob(chunks,{type:"audio/webm"});
    const r = new FileReader();
    r.onload = ()=> db.collection("messages").add({
      name: username,
      audio: r.result,
      time: Date.now()
    });
    r.readAsDataURL(b);
  };
  rec.start(); recording=true;
}

/* MESSAGES (SAFE RENDER) */
const rendered = new Set();

db.collection("messages")
  .orderBy("time")
  .onSnapshot(snap=>{
    snap.docChanges().forEach(change=>{
      if(change.type==="added"){
        if(rendered.has(change.doc.id)) return;
        rendered.add(change.doc.id);

        const m = change.doc.data();
        const b = document.createElement("div");
        b.className = "msg" + (m.name===username?" me":"");

        const n = document.createElement("div");
        n.className = "name " + nameClass(m.name);
        n.textContent = m.name;
        b.appendChild(n);

        if(m.text) b.appendChild(document.createTextNode(m.text));
        if(m.image){
          const i=document.createElement("img");
          i.src=m.image; b.appendChild(i);
        }
        if(m.audio){
          const a=document.createElement("audio");
          a.src=m.audio; a.controls=true;
          b.appendChild(a);
        }

        chat.appendChild(b);
        chat.scrollTop = chat.scrollHeight;
      }
    });
  });
</script>

</body>
</html>
