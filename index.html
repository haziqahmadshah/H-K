<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>H & K</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="H & K">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root {
  --blue: #4fc3ff;
  --pink: #ff8fb1;
  --bg: #0f2027;
  --panel: #0b1a20;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  height:100vh;
  display:flex;
  flex-direction:column;
  color:white;
  background:var(--bg);
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Ctext x='30' y='60' font-size='24' fill='rgba(255,140,160,0.12)'%3E‚ù§%3C/text%3E%3Ctext x='110' y='130' font-size='20' fill='rgba(255,140,160,0.1)'%3E‚ù§%3C/text%3E%3C/svg%3E");
  overflow:hidden;
}

/* HEADER */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:15px;
  font-weight:600;
  background:rgba(11,26,32,0.9);
  backdrop-filter:blur(15px);
  border-bottom: 1px solid rgba(255,255,255,0.05);
  z-index:10;
}
header span{flex:1;text-align:center;letter-spacing:1px}

/* PRESENCE */
.presence{
  display:flex;
  flex-direction:column;
  align-items:center;
  width:60px;
}
.dot{width:10px;height:10px;border-radius:50%;opacity:0.3;margin-bottom:4px;transition:0.3s;}
.dot.blue{background:var(--blue)}
.dot.pink{background:var(--pink)}
.dot.online{
  opacity:1;
  box-shadow:0 0 8px currentColor;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.2); opacity: 0.7; }
  100% { transform: scale(1); opacity: 1; }
}
.last-seen{font-size:9px;opacity:0.6;white-space:nowrap}

/* CHAT AREA */
#chat{
  flex:1;
  overflow-y:auto;
  padding:15px;
  display:flex;
  flex-direction:column;
  gap:12px;
  scroll-behavior:smooth;
  -webkit-overflow-scrolling: touch;
}

.unread-divider{
  align-self:center;
  font-size:11px;
  color: var(--pink);
  background:rgba(255,143,177,0.15);
  padding:4px 12px;
  border-radius:20px;
  margin:10px 0;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.day{align-self:center;font-size:11px;opacity:0.5;margin:10px 0;}

/* MESSAGES */
.msg{
  background:#203a43;
  padding:12px 16px;
  border-radius:18px;
  border-bottom-left-radius:4px;
  max-width:80%;
  align-self:flex-start;
  transition: transform 0.2s;
}
.msg.me{
  background:#2c5364;
  align-self:flex-end;
  border-bottom-left-radius:18px;
  border-bottom-right-radius:4px;
}

.name{font-size:11px;margin-bottom:4px;font-weight:700;text-transform:uppercase}
.name.blue{color:var(--blue)}
.name.pink{color:var(--pink)}

.reply-preview{
  background:rgba(0,0,0,0.2);
  border-left:3px solid var(--pink);
  padding:6px 10px;
  border-radius:4px;
  margin-bottom:8px;
  font-size:12px;
  opacity:0.8;
}

.img{max-width:100%;border-radius:10px;margin-top:8px;display:block;}

.reaction-strip{display:flex;gap:4px;margin-top:8px;}
.reaction-chip{background:rgba(255,255,255,0.1);padding:2px 7px;border-radius:10px;font-size:13px;}

/* ACTIONS (HIDDEN BY DEFAULT) */
.actions{
  display:none;
  flex-direction:column;
  gap:8px;
  margin-top:10px;
  padding-top:8px;
  border-top:1px solid rgba(255,255,255,0.1);
}
.reaction-picker{display:flex;justify-content:space-around;}
.reaction-picker span{font-size:22px;cursor:pointer;transition:transform 0.1s;}
.reaction-picker span:active{transform:scale(1.4);}

.reply-btn{font-size:12px;opacity:0.7;text-align:center;padding:4px;}

.time{font-size:9px;opacity:0.4;text-align:right;margin-top:4px;}

/* INPUT AREA */
#replyBar{
  display:none;
  padding:8px 15px;
  background:rgba(255,143,177,0.1);
  border-top:1px solid rgba(255,143,177,0.2);
  font-size:12px;
  justify-content:space-between;
  align-items:center;
}
#typing{font-size:11px;opacity:0.5;padding:5px 15px;height:16px;}

#bar{
  display:flex;
  align-items:flex-end;
  gap:10px;
  padding:12px;
  background:var(--panel);
  padding-bottom: calc(12px + env(safe-area-inset-bottom));
}

#msg{
  flex:1;
  background:#1a2a30;
  color:white;
  border:none;
  border-radius:20px;
  padding:10px 15px;
  font-size:16px;
  max-height:120px;
  resize:none;
}

.icon{font-size:24px;cursor:pointer;padding-bottom:6px;}

button{
  background:var(--pink);
  color:white;
  border:none;
  border-radius:50%;
  width:42px;
  height:42px;
  font-weight:bold;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
}
</style>
</head>

<body>

<header>
  <div class="presence">
    <div id="dot-h" class="dot blue"></div>
    <div id="last-h" class="last-seen">...</div>
  </div>

  <span>üíó H & K</span>

  <div class="presence">
    <div id="dot-k" class="dot pink"></div>
    <div id="last-k" class="last-seen">...</div>
  </div>
</header>

<div id="chat"></div>
<div id="typing"></div>

<div id="replyBar">
  <div>Replying to <span id="replyName" style="font-weight:bold"></span></div>
  <span onclick="cancelReply()" style="cursor:pointer;padding:5px">‚úï</span>
</div>

<div id="bar">
  <span class="icon" onclick="pickImage()">üì∑</span>
  <textarea id="msg" placeholder="Message..." rows="1"></textarea>
  <button onclick="send()">‚ûî</button>
</div>

<input type="file" id="imgPicker" accept="image/*" hidden>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* CONFIG & AUTH */
const CHAT_PASSWORD = "Chingam";
const allowed = ["haziq", "kaunain"];

if(localStorage.getItem("chat_pass") !== CHAT_PASSWORD){
  let p = prompt("Enter password:");
  if(p !== CHAT_PASSWORD) { document.body.innerHTML = ""; throw ""; }
  localStorage.setItem("chat_pass", CHAT_PASSWORD);
}

let username = localStorage.getItem("chat_name");
if(!username){
  username = prompt("Your name?");
  localStorage.setItem("chat_name", username || "Unknown");
}

const isAllowed = allowed.includes(username.toLowerCase());
const STARTUP_READ_TIME = Number(localStorage.getItem("last_read_time") || 0);
let replyData = null;

/* FIREBASE INIT */
firebase.initializeApp({
  apiKey: "AIzaSyB0FpYJytVZuHjtHjL5-RDK1MlIEEi6K6c",
  authDomain: "private-chat-4f4b9.firebaseapp.com",
  projectId: "private-chat-4f4b9"
});
const db = firebase.firestore();
const del = firebase.firestore.FieldValue.delete();

/* UI ELEMENTS */
const chatEl = document.getElementById('chat');
const msgInput = document.getElementById('msg');

/* PRESENCE SYSTEM */
function heartbeat(){
  db.collection("presence").doc(username).set({name:username, time:Date.now()},{merge:true});
}
setInterval(heartbeat, 5000);
heartbeat();

db.collection("presence").onSnapshot(s => {
  let states = {haziq: null, kaunain: null};
  s.forEach(d => {
    const data = d.data();
    if(data.name.toLowerCase().includes("haziq")) states.haziq = data.time;
    if(data.name.toLowerCase().includes("kaunain")) states.kaunain = data.time;
  });
  updateUI("h", states.haziq);
  updateUI("k", states.kaunain);
});

function updateUI(id, time){
  const dot = document.getElementById("dot-"+id);
  const label = document.getElementById("last-"+id);
  if(!time) return;
  const diff = Date.now() - time;
  dot.className = `dot ${id==='h'?'blue':'pink'}`;
  if(diff < 10000) { dot.classList.add("online"); label.textContent = "online"; }
  else {
    const d = new Date(time);
    label.textContent = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }
}

/* TYPING LOGIC */
msgInput.addEventListener("input", () => {
  db.collection("typing").doc("status").set({name:username, time:Date.now()});
  // Auto-resize textarea
  msgInput.style.height = 'auto';
  msgInput.style.height = (msgInput.scrollHeight) + 'px';
});

db.collection("typing").doc("status").onSnapshot(d => {
  if(!d.exists) return;
  const v = d.data();
  document.getElementById("typing").textContent = 
    (v.name !== username && Date.now() - v.time < 3000) ? `${v.name} is typing...` : "";
});

/* SENDING */
function send(){
  const t = msgInput.value.trim();
  if(!isAllowed || (!t && !replyData)) return;

  const payload = { name: username, text: t, time: Date.now() };
  if(replyData) { payload.replyTo = replyData; cancelReply(); }
  
  db.collection("messages").add(payload);
  msgInput.value = "";
  msgInput.style.height = 'auto';
}

msgInput.addEventListener("keydown", (e) => {
  if(e.key === "Enter" && !e.shiftKey && window.innerWidth > 600) {
    e.preventDefault(); send();
  }
});

function cancelReply(){
  replyData = null;
  document.getElementById("replyBar").style.display = "none";
}

/* IMAGES */
function pickImage() { document.getElementById('imgPicker').click(); }
document.getElementById('imgPicker').onchange = (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    db.collection("messages").add({ name:username, image: reader.result, time: Date.now() });
  };
  reader.readAsDataURL(file);
};

/* RENDERING */
function nameClass(n){
  return n.toLowerCase().includes("haziq") ? "blue" : "pink";
}

db.collection("messages").orderBy("time").onSnapshot(s => {
  const isAtBottom = chatEl.scrollHeight - chatEl.scrollTop <= chatEl.clientHeight + 100;
  chatEl.innerHTML = "";
  let lastDate = null;
  let unreadShown = false;

  s.forEach(doc => {
    const d = doc.data();
    const date = new Date(d.time);

    // Unread Divider
    if(!unreadShown && d.time > STARTUP_READ_TIME && STARTUP_READ_TIME > 0 && d.name !== username){
      const div = document.createElement("div");
      div.className = "unread-divider";
      div.textContent = "New Messages";
      chatEl.appendChild(div);
      unreadShown = true;
    }

    // Date Separator
    if(!lastDate || lastDate.toDateString() !== date.toDateString()){
      const sep = document.createElement("div");
      sep.className = "day";
      sep.textContent = date.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'});
      chatEl.appendChild(sep);
      lastDate = date;
    }

    // Message Bubble
    const m = document.createElement("div");
    m.className = `msg ${d.name === username ? 'me' : ''}`;
    
    let html = `<div class="name ${nameClass(d.name)}">${d.name}</div>`;
    if(d.replyTo) html += `<div class="reply-preview">${d.replyTo.name}: ${d.replyTo.text}</div>`;
    if(d.text) html += `<div>${d.text.replace(/\n/g, '<br>')}</div>`;
    if(d.image) html += `<img src="${d.image}" class="img">`;
    
    if(d.reactions){
      html += `<div class="reaction-strip">`;
      Object.entries(d.reactions).forEach(([user, emoji]) => {
        html += `<div class="reaction-chip">${emoji}</div>`;
      });
      html += `</div>`;
    }
    
    html += `<div class="actions">
      <div class="reaction-picker">
        ${["‚ù§Ô∏è","ü©∑","‚ú®","üòÇ","üíÄ","üî•"].map(emo => `<span onclick="react('${doc.id}', '${emo}')">${emo}</span>`).join('')}
      </div>
      <div class="reply-btn" onclick="startReply('${d.name}', '${d.text || "Image"}')">Reply</div>
    </div>`;
    
    html += `<div class="time">${date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>`;
    
    m.innerHTML = html;
    m.onclick = (e) => {
      if(e.target.tagName !== 'SPAN') {
        const acts = m.querySelector('.actions');
        acts.style.display = acts.style.display === 'flex' ? 'none' : 'flex';
      }
    };
    
    chatEl.appendChild(m);
  });

  if(isAtBottom) chatEl.scrollTop = chatEl.scrollHeight;
  localStorage.setItem("last_read_time", Date.now());
});

function react(id, emo){
  const ref = db.collection("messages").doc(id);
  ref.get().then(doc => {
    const data = doc.data();
    const reactions = data.reactions || {};
    if(reactions[username] === emo) delete reactions[username];
    else reactions[username] = emo;
    ref.update({ reactions });
  });
}

function startReply(name, text){
  replyData = { name, text: text.substring(0, 50) + (text.length > 50 ? '...' : '') };
  document.getElementById("replyName").textContent = name;
  document.getElementById("replyBar").style.display = "flex";
  msgInput.focus();
}
</script>

</body>
</html>
