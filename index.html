<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>H & K</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="H & K">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  height:100vh;
  display:flex;
  flex-direction:column;
  color:white;
  background:#0f2027;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Ctext x='30' y='60' font-size='24' fill='rgba(255,140,160,0.12)'%3E‚ù§%3C/text%3E%3Ctext x='110' y='130' font-size='20' fill='rgba(255,140,160,0.1)'%3E‚ù§%3C/text%3E%3C/svg%3E");
  background-repeat:repeat;
}

/* FIX: Ensure messages don't go behind header/footer */
#chat{
  flex:1;
  overflow-y:auto;
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
  scroll-behavior:smooth;
}

/* FEATURE 3: UNREAD DIVIDER */
.unread-divider{
  align-self:center;
  font-size:12px;
  opacity:0.9;
  background:rgba(255,255,255,0.2);
  color: #fff;
  padding:4px 10px;
  border-radius:12px;
  margin:6px 0;
}
  
/* HEADER */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px;
  font-weight:600;
  background:rgba(11,26,32,0.95);
  backdrop-filter:blur(10px);
  z-index:10;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
header span{flex:1;text-align:center}

/* PRESENCE */
.presence{
  display:flex;
  flex-direction:column;
  align-items:center;
  font-size:10px;
  width: 60px;
}

/* DOTS */
.dot{width:10px;height:10px;border-radius:50%;opacity:0.3;margin-bottom:3px}
.dot.blue{background:#4fc3ff}
.dot.pink{background:#ff8fb1}
.dot.online{opacity:1;box-shadow:0 0 6px currentColor,0 0 12px currentColor}
.dot.idle{opacity:0.6}

.day{
  align-self:center;
  font-size:12px;
  opacity:0.6;
  margin: 5px 0;
}

/* MESSAGE - FIX: Visibility and Contrast */
.msg{
  background:#203a43;
  padding:10px 14px 8px;
  border-radius:18px;
  max-width:75%;
  align-self:flex-start;
  position:relative;
  color: #ffffff; /* Explicit text color */
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.me{background:#2c5364;align-self:flex-end}

.name{font-size:11px;margin-bottom:4px;font-weight:700}
.name.blue{color:#4fc3ff}
.name.pink{color:#ff8fb1}

.time{
  font-size:10px;
  opacity:0.6;
  text-align:right;
  margin-top: 4px;
}

.img{
  max-width:100%;
  border-radius:12px;
  margin-top:6px;
  display: block;
}

/* REPLY PREVIEW */
.reply-preview{
  border-left:3px solid #ff8fb1;
  padding:5px 8px;
  margin-bottom:6px;
  font-size:12px;
  background: rgba(0,0,0,0.2);
  border-radius: 4px;
}

/* ACTION PANEL */
.actions{
  display:none;
  flex-direction:column;
  gap:10px;
  margin-top:10px;
  padding-top: 8px;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.reaction-strip{
  display:flex;
  gap:6px;
  margin-top:6px;
  flex-wrap: wrap;
}
.reaction-chip{
  background:rgba(255,255,255,0.15);
  padding:2px 8px;
  border-radius:12px;
  font-size:14px;
}
.reaction-picker{
  display:flex;
  gap:12px;
  justify-content: center;
}
.reaction-picker span{
  font-size:22px;
  cursor:pointer;
}

.reply-btn{
  font-size:12px;
  opacity:0.8;
  cursor:pointer;
  text-align: center;
  padding: 5px;
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
}

/* REPLY BAR */
#replyBar{
  display:none;
  padding:8px 14px;
  background:rgba(255,143,177,0.2);
  font-size:12px;
  justify-content: space-between;
  align-items: center;
}
#replyBar b{color: #ff8fb1;}

/* TYPING */
#typing{
  font-size:12px;
  opacity:0.6;
  padding:4px 14px;
  min-height:16px;
}

/* INPUT FIX: Sticky bottom on mobile */
#bar{
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px;
  background:rgba(11,26,32,0.98);
  padding-bottom: calc(12px + env(safe-area-inset-bottom));
}

#msg{
  flex:1;
  min-height:40px;
  max-height: 120px;
  resize:none;
  padding:10px 14px;
  border-radius:20px;
  border:none;
  font-size:16px;
  background: #1a2a30;
  color: white;
  outline: none;
}

.icon{font-size:24px;cursor:pointer}

button{
  min-height:40px;
  padding:0 18px;
  border-radius:20px;
  border:none;
  background:#ff8fb1;
  color: white;
  font-weight:600;
  cursor: pointer;
}
</style>
</head>

<body>

<header>
  <div class="presence">
    <div id="dot-h" class="dot blue"></div>
    <div id="last-h">offline</div>
  </div>

  <span>üíó H & K</span>

  <div class="presence">
    <div id="dot-k" class="dot pink"></div>
    <div id="last-k">offline</div>
  </div>
</header>

<div id="chat"></div>
<div id="typing"></div>

<div id="replyBar">
  <span>Replying to <b id="replyName"></b></span>
  <span onclick="cancelReply()" style="cursor:pointer; font-size: 16px;">‚úï</span>
</div>

<div id="bar">
  <span class="icon" onclick="pickImage()">üì∑</span>
  <textarea id="msg" placeholder="Message‚Ä¶" rows="1"></textarea>
  <button onclick="send()">Send</button>
</div>

<input type="file" id="imgPicker" accept="image/*" hidden>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
let replyData=null;

/* PASSWORD CHECK */
const CHAT_PASSWORD="Chingam";
if(localStorage.getItem("chat_pass")!==CHAT_PASSWORD){
  if(prompt("Enter password:")!==CHAT_PASSWORD){
    document.body.innerHTML="";
    throw "";
  }
  localStorage.setItem("chat_pass",CHAT_PASSWORD);
}

const STARTUP_READ_TIME = Number(localStorage.getItem("last_read_time") || 0);

/* NAME SETUP */
let username=localStorage.getItem("chat_name");
if(!username){
  username=prompt("Your name?");
  localStorage.setItem("chat_name",username||"Unknown");
}

const allowed=["haziq","kaunain"];
const isAllowed=allowed.includes(username.toLowerCase());
if(!isAllowed){
  document.getElementById('msg').disabled=true;
  document.getElementById('msg').placeholder="Read-only mode";
}

function nameClass(n){
  n=(n||"").toLowerCase();
  if(n.includes("haziq")) return "blue";
  if(n.includes("kaunain")) return "pink";
  return "";
}

/* FIREBASE INITIALIZATION */
firebase.initializeApp({
  apiKey:"AIzaSyB0FpYJytVZuHjtHjL5-RDK1MlIEEi6K6c",
  authDomain:"private-chat-4f4b9.firebaseapp.com",
  projectId:"private-chat-4f4b9"
});
const db=firebase.firestore();
const del=firebase.firestore.FieldValue.delete();

/* PRESENCE SYSTEM */
const presence=db.collection("presence");
function heartbeat(){
  presence.doc(username).set({name:username,time:Date.now()},{merge:true});
}
heartbeat();
setInterval(heartbeat,5000);

presence.onSnapshot(s=>{
  let hTime=null,kTime=null;
  s.forEach(d=>{
    const n=d.data().name.toLowerCase();
    if(n.includes("haziq")) hTime=d.data().time;
    if(n.includes("kaunain")) kTime=d.data().time;
  });
  updatePresence("h",hTime);
  updatePresence("k",kTime);
});

function updatePresence(who,time){
  const dot=document.getElementById("dot-"+who);
  const label=document.getElementById("last-"+who);
  dot.classList.remove("online","idle");
  if(!time){ label.textContent="offline"; return; }
  const age=Date.now()-time;
  if(age<8000){ dot.classList.add("online"); label.textContent="online"; }
  else if(age<20000){ dot.classList.add("idle"); label.textContent="idle"; }
  else {
    label.textContent=new Date(time).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});
  }
}

/* TYPING INDICATOR */
const msgInput = document.getElementById('msg');
msgInput.addEventListener("input",()=>{
  db.collection("typing").doc("status").set({name:username,time:Date.now()},{merge:true});
});
db.collection("typing").doc("status").onSnapshot(d=>{
  if(!d.exists) return;
  const v=d.data();
  document.getElementById("typing").textContent=(v.name!==username && Date.now()-v.time<3000)
    ? `${v.name} is typing‚Ä¶` : "";
});

/* SEND FUNCTION */
function send(){
  if(!isAllowed) return;
  const t=msgInput.value.trim();
  if(!t && !replyData) return;

  const payload={name:username,text:t,time:Date.now()};
  if(replyData){ payload.replyTo=replyData; cancelReply(); }
  
  db.collection("messages").add(payload);
  msgInput.value="";
  msgInput.style.height = 'auto'; // Reset height
  msgInput.focus();
}

function cancelReply(){
  replyData=null;
  document.getElementById("replyBar").style.display="none";
}

/* IMAGE SYSTEM */
function pickImage(){ document.getElementById('imgPicker').click(); }
document.getElementById('imgPicker').onchange=(e)=>{
  if(!isAllowed) return;
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=()=>db.collection("messages").add({
    name:username,image:r.result,time:Date.now()
  });
  r.readAsDataURL(f);
};

/* HELPERS */
function sameDay(a,b){ return a.toDateString() === b.toDateString(); }
function dayLabel(d){
  const t=new Date();
  const y=new Date(); y.setDate(t.getDate()-1);
  if(sameDay(d,t)) return "Today";
  if(sameDay(d,y)) return "Yesterday";
  return d.toLocaleDateString([], {month:'short', day:'numeric'});
}

/* MAIN CHAT LISTENER */
db.collection("messages").orderBy("time").onSnapshot(s=>{
  const chat = document.getElementById('chat');
  chat.innerHTML="";
  let unreadInserted = false;
  let last=null;

  s.forEach(doc=>{
    const d=doc.data();
    const dt=new Date(d.time);

    // Unread Divider Logic
    if(!unreadInserted && d.time > STARTUP_READ_TIME && STARTUP_READ_TIME > 0 && d.name !== username){
      const u=document.createElement("div");
      u.className="unread-divider";
      u.textContent="New messages";
      chat.appendChild(u);
      unreadInserted=true;
    }

    // Day Separator
    if(!last || !sameDay(last,dt)){
      const sep=document.createElement("div");
      sep.className="day";
      sep.textContent=dayLabel(dt);
      chat.appendChild(sep);
      last=dt;
    }

    const b=document.createElement("div");
    b.className="msg"+(d.name===username?" me":"");

    const n=document.createElement("div");
    n.className="name "+nameClass(d.name);
    n.textContent=d.name;
    b.appendChild(n);

    if(d.replyTo){
      const rp=document.createElement("div");
      rp.className="reply-preview";
      rp.textContent=`${d.replyTo.name}: ${d.replyTo.text}`;
      b.appendChild(rp);
    }

    if(d.text){
      const txt = document.createElement("div");
      txt.style.whiteSpace = "pre-wrap";
      txt.textContent = d.text;
      b.appendChild(txt);
    }

    if(d.image){
      const i=document.createElement("img");
      i.src=d.image;
      i.className="img";
      b.appendChild(i);
    }

    if(d.reactions){
      const rs=document.createElement("div");
      rs.className="reaction-strip";
      Object.values(d.reactions).forEach(e=>{
        const c=document.createElement("div");
        c.className="reaction-chip";
        c.textContent=e;
        rs.appendChild(c);
      });
      b.appendChild(rs);
    }

    const act=document.createElement("div");
    act.className="actions";

    if(isAllowed){
      const picker=document.createElement("div");
      picker.className="reaction-picker";
      ["üòò","ü§ç","‚ù§Ô∏è","üòÇ","üñï","üíÄ"].forEach(e=>{
        const s=document.createElement("span");
        s.textContent=e;
        s.onclick=()=>{
          const cur=(d.reactions||{})[username];
          if(cur===e){
            doc.ref.update({["reactions."+username]:del});
          }else{
            doc.ref.update({["reactions."+username]:e});
          }
        };
        picker.appendChild(s);
      });
      act.appendChild(picker);

      const reply=document.createElement("div");
      reply.className="reply-btn";
      reply.textContent="Reply";
      reply.onclick=()=>{
        replyData={name:d.name,text:d.text||"[media]"};
        document.getElementById("replyName").textContent=d.name;
        document.getElementById("replyBar").style.display="flex";
        msgInput.focus();
      };
      act.appendChild(reply);
    }

    b.appendChild(act);
    b.onclick=(e)=>{
      if(e.target.tagName !== 'SPAN') {
        act.style.display = (act.style.display==="flex" ? "none" : "flex");
      }
    };

    const tm=document.createElement("div");
    tm.className="time";
    tm.textContent=dt.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});
    b.appendChild(tm);

    chat.appendChild(b);
  });

  chat.scrollTop=chat.scrollHeight;
  localStorage.setItem("last_read_time", Date.now());
});

// Fix for auto-resize textarea
msgInput.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = (this.scrollHeight) + 'px';
});
</script>

</body>
</html>
