<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>H & K</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="H & K">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  height:100vh;
  display:flex;
  flex-direction:column;
  color:white;
  background:#0f2027;
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  backdrop-filter:blur(2px);
  z-index:-1;
}

/* HEADER */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px;
  background:rgba(11,26,32,0.88);
  backdrop-filter:blur(10px);
}
header span{ flex:1; text-align:center; font-weight:600 }

/* DOTS */
.dot{ width:10px;height:10px;border-radius:50%;opacity:.3 }
.dot.blue{ background:#4fc3ff }
.dot.pink{ background:#ff8fb1 }
.dot.online{ opacity:1; box-shadow:0 0 6px currentColor }
.dot.idle{ opacity:.6 }

/* CHAT */
#chat{
  flex:1;
  overflow-y:auto;
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.msg{
  background:#203a43;
  padding:10px 14px;
  border-radius:18px;
  max-width:75%;
}
.me{ background:#2c5364; align-self:flex-end }

.name{
  font-size:11px;
  font-weight:600;
  margin-bottom:4px;
}
.name.blue{ color:#4fc3ff }
.name.pink{ color:#ff8fb1 }

.time,.seen{
  font-size:10px;
  opacity:.6;
  text-align:right;
}

/* INDICATORS */
#typing,#cameraStatus{
  font-size:12px;
  opacity:.7;
  padding:4px 14px;
  min-height:16px;
}

/* INPUT */
#bar{
  display:flex;
  gap:8px;
  padding:10px;
  background:rgba(11,26,32,0.95);
}
#msg{
  flex:1;
  min-height:42px;
  resize:none;
  padding:10px;
  border-radius:18px;
  border:none;
  font-size:16px;
}
button{
  padding:10px 18px;
  border-radius:22px;
  border:none;
  background:#ff8fb1;
}
</style>
</head>

<body>

<header>
  <div id="dot-h" class="dot blue"></div>
  <span>ðŸ’— H & K</span>
  <div id="dot-k" class="dot pink"></div>
</header>

<div id="chat"></div>
<div id="typing"></div>
<div id="cameraStatus"></div>

<div id="bar">
  <button onclick="pickImage()">ðŸ“·</button>
  <textarea id="msg" placeholder="Messageâ€¦"></textarea>
  <button onclick="send()">Send</button>
</div>

<input type="file" id="imgPicker" accept="image/*" hidden>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* USER */
let user=localStorage.getItem("u");
if(!user){ user=prompt("Your name?"); localStorage.setItem("u",user); }

function nameClass(n){
  n=n.toLowerCase();
  if(n.includes("haziq")) return "blue";
  if(n.includes("kaunain")) return "pink";
  return "";
}

/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyB0FpYJytVZuHjtHjL5-RDK1MlIEEi6K6c",
  authDomain:"private-chat-4f4b9.firebaseapp.com",
  projectId:"private-chat-4f4b9"
});
const db=firebase.firestore();

/* PRESENCE â€” FIXED & ISOLATED */
const presence=db.collection("presence");
function heartbeat(){
  presence.doc(user).set({ name:user, time:Date.now() });
}
heartbeat();
setInterval(heartbeat,4000);

presence.onSnapshot(snap=>{
  let now=Date.now(), h="offline", k="offline";
  snap.forEach(doc=>{
    const d=doc.data();
    const age=now-d.time;
    let state="offline";
    if(age<6000) state="online";
    else if(age<15000) state="idle";
    if(d.name.toLowerCase().includes("haziq")) h=state;
    if(d.name.toLowerCase().includes("kaunain")) k=state;
  });
  setDot("dot-h",h);
  setDot("dot-k",k);
});
function setDot(id,state){
  const el=document.getElementById(id);
  el.classList.remove("online","idle");
  if(state==="online") el.classList.add("online");
  if(state==="idle") el.classList.add("idle");
}

/* TYPING â€” FIXED */
let typingTimer;
msg.addEventListener("input",()=>{
  db.collection("typing").doc("status").set({
    name:user,
    time:Date.now()
  });
});
db.collection("typing").doc("status").onSnapshot(doc=>{
  if(!doc.exists) return;
  const d=doc.data();
  if(d.name!==user && Date.now()-d.time<2000){
    typing.textContent=`${d.name} is typingâ€¦`;
    clearTimeout(typingTimer);
    typingTimer=setTimeout(()=>typing.textContent="",1500);
  }
});

/* SEND */
function send(){
  const t=msg.value.trim();
  if(!t) return;
  db.collection("messages").add({
    name:user,
    text:t,
    time:Date.now()
  });
  msg.value="";
}

/* CAMERA */
function pickImage(){
  cameraStatus.textContent="ðŸ“· Camera openâ€¦";
  imgPicker.click();
}
imgPicker.onchange=()=>{
  cameraStatus.textContent="";
  const f=imgPicker.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    db.collection("messages").add({
      name:user,
      image:r.result,
      time:Date.now()
    });
  };
  r.readAsDataURL(f);
};

/* MESSAGES */
db.collection("messages").orderBy("time").onSnapshot(snap=>{
  chat.innerHTML="";
  snap.forEach(doc=>{
    const d=doc.data();
    const b=document.createElement("div");
    b.className="msg"+(d.name===user?" me":"");

    const n=document.createElement("div");
    n.className="name "+nameClass(d.name);
    n.textContent=d.name;
    b.appendChild(n);

    if(d.text) b.appendChild(document.createTextNode(d.text));

    const t=document.createElement("div");
    t.className="time";
    t.textContent=new Date(d.time).toLocaleTimeString([],{
      hour:"2-digit",minute:"2-digit"
    });
    b.appendChild(t);

    chat.appendChild(b);
  });
  chat.scrollTop=chat.scrollHeight;
});
</script>

</body>
</html>
