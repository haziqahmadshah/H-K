<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>H & K</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
/* ---------- BACKGROUND LAYER ---------- */
#bg {
  position: fixed;
  inset: 0;
  z-index: 0;
  background-color: #0f2027;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Ctext x='30' y='60' font-size='22' fill='rgba(255,140,160,0.15)'%3E‚ù§%3C/text%3E%3Ctext x='110' y='130' font-size='18' fill='rgba(255,140,160,0.12)'%3E‚ù§%3C/text%3E%3C/svg%3E");
  background-repeat: repeat;
  filter: blur(2px);
}

/* ---------- APP LAYER ---------- */
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  height: 100vh;
  overflow: hidden;
  color: white;
}

#app {
  position: relative;
  z-index: 1;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ---------- HEADER ---------- */
header {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 14px;
  background: rgba(11,26,32,0.92);
  backdrop-filter: blur(10px);
  z-index: 10;
}

header span { font-weight: 600; }

.dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  opacity: 0.25;
}
.blue { background: #4fc3ff; }
.pink { background: #ff8fb1; }

.online {
  opacity: 1;
  box-shadow: 0 0 8px currentColor, 0 0 14px currentColor;
}
.idle { opacity: 0.6; }

/* ---------- CHAT ---------- */
#chat {
  flex: 1;
  padding: 14px;
  padding-top: 70px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.msg {
  background: #203a43;
  padding: 10px 14px;
  border-radius: 18px;
  max-width: 75%;
}

.me {
  background: #2c5364;
  align-self: flex-end;
}

.name {
  font-size: 11px;
  margin-bottom: 4px;
  font-weight: 600;
}

.name.blue { color: #4fc3ff; }
.name.pink { color: #ff8fb1; }

img, audio {
  max-width: 100%;
  border-radius: 12px;
  margin-top: 6px;
}

/* ---------- INPUT ---------- */
#bar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px;
  background: rgba(11,26,32,0.95);
}

#msg {
  flex: 1;
  padding: 12px 16px;
  border-radius: 22px;
  border: none;
  outline: none;
  font-size: 16px;
}

button {
  padding: 10px 14px;
  border-radius: 22px;
  border: none;
  background: #ff8fb1;
  color: #0b1a20;
  font-weight: 600;
}

.icon { font-size: 22px; cursor: pointer; }
</style>
</head>

<body>

<div id="bg"></div>

<div id="app">
  <header>
    <div id="dot-h" class="dot blue"></div>
    <span>üíó H & K</span>
    <div id="dot-k" class="dot pink"></div>
  </header>

  <div id="chat"></div>

  <div id="bar">
    <div class="icon" onclick="pickImage()">üì∑</div>
    <div class="icon" onclick="toggleRecord()">üé§</div>
    <input id="msg" placeholder="Message‚Ä¶" autocomplete="off">
    <button onclick="send()">Send</button>
  </div>
</div>

<input type="file" id="imgPicker" accept="image/*" hidden>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ---------- AUTH (SIMPLE + SAFE) ---------- */
const ALLOWED = ["haziq", "kaunain"];
const PASSWORD = "hnk123";

let username = localStorage.getItem("chat_name");
if (!username) {
  username = prompt("Your name?");
  if (!ALLOWED.includes(username.toLowerCase())) {
    document.body.innerHTML = "";
    throw "Blocked";
  }
  if (prompt("Password:") !== PASSWORD) {
    document.body.innerHTML = "";
    throw "Blocked";
  }
  localStorage.setItem("chat_name", username);
}

/* ---------- FIREBASE ---------- */
firebase.initializeApp({
  apiKey: "AIzaSyB0FpYJytVZuHjtHjL5-RDK1MlIEEi6K6c",
  authDomain: "private-chat-4f4b9.firebaseapp.com",
  projectId: "private-chat-4f4b9"
});
const db = firebase.firestore();

/* ---------- PRESENCE ---------- */
const presence = db.collection("presence");
function ping() {
  presence.doc(username).set({ name: username, time: Date.now() });
}
setInterval(ping, 3000);
ping();

presence.onSnapshot(snap => {
  let now = Date.now();
  snap.forEach(d => {
    let dt = now - d.data().time;
    let el = d.data().name.toLowerCase() === "haziq" ? dot-h : dot-k;
    el.className = "dot " + (el === dot-h ? "blue" : "pink");
    if (dt < 5000) el.classList.add("online");
    else if (dt < 12000) el.classList.add("idle");
  });
});

/* ---------- CHAT ---------- */
function send() {
  let t = msg.value.trim();
  if (!t) return;
  db.collection("messages").add({ name: username, text: t, time: Date.now() });
  msg.value = "";
  msg.focus();
}

function pickImage() {
  imgPicker.click();
}

imgPicker.onchange = () => {
  let f = imgPicker.files[0];
  if (!f) return;
  let r = new FileReader();
  r.onload = () => db.collection("messages").add({
    name: username,
    image: r.result,
    time: Date.now()
  });
  r.readAsDataURL(f);
};

let rec, chunks = [], recording = false;
async function toggleRecord() {
  if (recording) { rec.stop(); recording = false; return; }
  let s = await navigator.mediaDevices.getUserMedia({ audio: true });
  rec = new MediaRecorder(s);
  chunks = [];
  rec.ondataavailable = e => chunks.push(e.data);
  rec.onstop = () => {
    let b = new Blob(chunks, { type: "audio/webm" });
    let r = new FileReader();
    r.onload = () => db.collection("messages").add({
      name: username,
      audio: r.result,
      time: Date.now()
    });
    r.readAsDataURL(b);
  };
  rec.start();
  recording = true;
}

/* ---------- MESSAGE LIST ---------- */
db.collection("messages").orderBy("time").onSnapshot(snap => {
  chat.innerHTML = "";
  snap.forEach(d => {
    let m = d.data();
    let b = document.createElement("div");
    b.className = "msg" + (m.name === username ? " me" : "");
    let n = document.createElement("div");
    n.className = "name " + (m.name.toLowerCase() === "haziq" ? "blue" : "pink");
    n.textContent = m.name;
    b.appendChild(n);
    if (m.text) b.appendChild(document.createTextNode(m.text));
    if (m.image) { let i = document.createElement("img"); i.src = m.image; b.appendChild(i); }
    if (m.audio) { let a = document.createElement("audio"); a.src = m.audio; a.controls = true; b.appendChild(a); }
    chat.appendChild(b);
  });
  chat.scrollTop = chat.scrollHeight;
});
</script>

</body>
</html>
