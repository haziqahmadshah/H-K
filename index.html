<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>H & K</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="H & K">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
/* --- BASELINE STYLES (unchanged) --- */
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  height:100vh;
  display:flex;
  flex-direction:column;
  color:white;
  background:#0f2027;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Ctext x='30' y='60' font-size='24' fill='rgba(255,140,160,0.12)'%3E‚ù§%3C/text%3E%3Ctext x='110' y='130' font-size='20' fill='rgba(255,140,160,0.1)'%3E‚ù§%3C/text%3E%3C/svg%3E");
  background-repeat:repeat;
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  backdrop-filter:blur(2px);
  z-index:-1;
}

/* HEADER */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px;
  font-weight:600;
  background:rgba(11,26,32,0.88);
  backdrop-filter:blur(10px);
  z-index:10;
}
header span{ flex:1; text-align:center; }

/* DOTS */
.dot{ width:10px;height:10px;border-radius:50%;opacity:.3 }
.dot.blue{ background:#4fc3ff }
.dot.pink{ background:#ff8fb1 }
.dot.online{ opacity:1; box-shadow:0 0 6px currentColor,0 0 12px currentColor }
.dot.idle{ opacity:.6 }

/* CHAT */
#chat{
  flex:1;
  overflow-y:auto;
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
  z-index:5;
}

.day{
  align-self:center;
  font-size:12px;
  opacity:.6;
  margin:8px 0;
}

.msg{
  background:#203a43;
  padding:10px 14px 8px;
  border-radius:18px;
  max-width:75%;
  align-self:flex-start;
  position:relative;
}
.me{ background:#2c5364; align-self:flex-end }

.name{
  font-size:11px;
  margin-bottom:4px;
  font-weight:600;
}
.name.blue{ color:#4fc3ff }
.name.pink{ color:#ff8fb1 }

.time{
  font-size:10px;
  opacity:.6;
  margin-top:4px;
  text-align:right;
}

.seen{
  font-size:10px;
  opacity:.6;
  margin-top:2px;
  text-align:right;
}

.img{
  max-width:100%;
  border-radius:12px;
  margin-top:6px;
}

/* REACTIONS */
.reactions{
  display:flex;
  gap:4px;
  margin-top:4px;
}
.reaction{
  font-size:14px;
  opacity:.9;
}

.reaction-bar{
  display:none;
  position:absolute;
  bottom:100%;
  left:10px;
  background:#162b33;
  border-radius:14px;
  padding:6px;
  gap:6px;
}
.reaction-bar span{
  cursor:pointer;
  font-size:18px;
}

/* INPUT */
#typing{
  font-size:12px;
  opacity:.6;
  padding:0 14px 6px;
  min-height:16px;
}

#bar{
  display:flex;
  align-items:flex-end;
  gap:8px;
  padding:10px;
  background:rgba(11,26,32,0.95);
  backdrop-filter:blur(12px);
}

#msg{
  flex:1;
  min-height:42px;
  max-height:120px;
  resize:none;
  padding:10px 14px;
  border-radius:18px;
  border:none;
  outline:none;
  font-size:16px;
}

button{
  padding:10px 18px;
  border-radius:22px;
  border:none;
  background:#ff8fb1;
  font-weight:600;
}
</style>
</head>

<body>

<header>
  <div id="dot-h" class="dot blue"></div>
  <span>üíó H & K</span>
  <div id="dot-k" class="dot pink"></div>
</header>

<div id="chat"></div>
<div id="typing"></div>

<div id="bar">
  <textarea id="msg" placeholder="Message‚Ä¶"></textarea>
  <button onclick="send()">Send</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* PASSWORD */
const PASS="hnk123";
if(localStorage.getItem("p")!==PASS){
  if(prompt("Password")!==PASS){document.body.innerHTML="";throw""}
  localStorage.setItem("p",PASS);
}

/* USER */
let user=localStorage.getItem("u");
if(!user){user=prompt("Your name?");localStorage.setItem("u",user);}

const allowed=["haziq","kaunain"];
const canTalk=allowed.includes(user.toLowerCase());

/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyB0FpYJytVZuHjtHjL5-RDK1MlIEEi6K6c",
  authDomain:"private-chat-4f4b9.firebaseapp.com",
  projectId:"private-chat-4f4b9"
});
const db=firebase.firestore();

/* READ RECEIPTS */
const reads=db.collection("reads");
reads.doc(user).set({ time:Date.now() });

/* SEND */
function send(){
  if(!canTalk) return;
  const t=msg.value.trim();
  if(!t) return;
  db.collection("messages").add({
    name:user,
    text:t,
    time:Date.now()
  });
  msg.value="";
}

/* DAY HELPERS */
function sameDay(a,b){
  return a.getFullYear()===b.getFullYear() &&
         a.getMonth()===b.getMonth() &&
         a.getDate()===b.getDate();
}

/* MESSAGES */
db.collection("messages").orderBy("time").onSnapshot(snap=>{
  chat.innerHTML="";
  let lastDay=null;
  let lastOwnMessage=null;

  snap.forEach(doc=>{
    const d=doc.data();
    const date=new Date(d.time);

    if(!lastDay || !sameDay(lastDay,date)){
      const sep=document.createElement("div");
      sep.className="day";
      sep.textContent=date.toDateString();
      chat.appendChild(sep);
      lastDay=date;
    }

    const bubble=document.createElement("div");
    bubble.className="msg"+(d.name===user?" me":"");

    /* Reaction bar */
    const bar=document.createElement("div");
    bar.className="reaction-bar";
    ["üòò","ü§ç","ü©∑","‚ù§Ô∏è","üñï","üíÄ"].forEach(e=>{
      const s=document.createElement("span");
      s.textContent=e;
      s.onclick=()=>{
        doc.ref.set({
          reactions:{ ...(d.reactions||{}), [user]:e }
        },{ merge:true });
        bar.style.display="none";
      };
      bar.appendChild(s);
    });
    bubble.appendChild(bar);

    bubble.onclick=()=>{
      bar.style.display=bar.style.display==="flex"?"none":"flex";
      bar.style.display="flex";
    };

    const name=document.createElement("div");
    name.className="name";
    name.textContent=d.name;
    bubble.appendChild(name);

    if(d.text) bubble.appendChild(document.createTextNode(d.text));

    if(d.reactions){
      const r=document.createElement("div");
      r.className="reactions";
      Object.values(d.reactions).forEach(x=>{
        const rx=document.createElement("span");
        rx.className="reaction";
        rx.textContent=x;
        r.appendChild(rx);
      });
      bubble.appendChild(r);
    }

    const t=document.createElement("div");
    t.className="time";
    t.textContent=date.toLocaleTimeString([],{
      hour:"2-digit",minute:"2-digit"
    });
    bubble.appendChild(t);

    if(d.name===user) lastOwnMessage=bubble;

    chat.appendChild(bubble);
  });

  /* SEEN */
  reads.get().then(s=>{
    s.forEach(r=>{
      if(r.id!==user && lastOwnMessage){
        const seen=document.createElement("div");
        seen.className="seen";
        seen.textContent="Seen";
        lastOwnMessage.appendChild(seen);
      }
    });
  });

  chat.scrollTop=chat.scrollHeight;
});
</script>

</body>
</html>
