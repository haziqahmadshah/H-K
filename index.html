<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>H & K</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="H & K">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  height:100vh;
  display:flex;
  flex-direction:column;
  color:white;
  background:#0f2027;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Ctext x='30' y='60' font-size='22' fill='rgba(255,140,160,0.12)'%3E‚ù§%3C/text%3E%3Ctext x='110' y='130' font-size='18' fill='rgba(255,140,160,0.1)'%3E‚ù§%3C/text%3E%3C/svg%3E");
  background-repeat:repeat;
  overflow:hidden;
}

/* HEADER */
header{
  position:fixed;
  top:0; left:0; right:0;
  height:56px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 14px;
  background:rgba(11,26,32,0.95);
  z-index:10;
}

header span{ font-weight:600; }

.dot{
  width:10px; height:10px;
  border-radius:50%;
  opacity:0.25;
}

.blue{ background:#4fc3ff; }
.pink{ background:#ff8fb1; }

.online{
  opacity:1;
  box-shadow:0 0 8px currentColor,0 0 14px currentColor;
}

.idle{ opacity:0.6; }

/* CHAT */
#chat{
  flex:1;
  overflow-y:auto;
  padding:14px;
  padding-top:70px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.msg{
  background:#203a43;
  padding:10px 14px;
  border-radius:18px;
  max-width:75%;
}

.me{
  background:#2c5364;
  align-self:flex-end;
}

.name{
  font-size:11px;
  margin-bottom:4px;
  font-weight:600;
}

.name.blue{ color:#4fc3ff; }
.name.pink{ color:#ff8fb1; }

img,audio{
  max-width:100%;
  border-radius:12px;
  margin-top:6px;
}

/* INPUT BAR */
#bar{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px;
  background:rgba(11,26,32,0.98);
}

#msg{
  flex:1;
  padding:12px 16px;
  border-radius:22px;
  border:none;
  outline:none;
  font-size:16px;
}

button{
  padding:10px 14px;
  border-radius:22px;
  border:none;
  background:#ff8fb1;
  color:#0b1a20;
  font-weight:600;
}

.icon{ font-size:22px; cursor:pointer; }
</style>
</head>

<body>

<header>
  <div id="dot-h" class="dot blue"></div>
  <span>üíó H & K</span>
  <div id="dot-k" class="dot pink"></div>
</header>

<div id="chat"></div>

<div id="bar">
  <div class="icon" onclick="pickImage()">üì∑</div>
  <div class="icon" onclick="toggleRecord()">üé§</div>
  <input id="msg" placeholder="Message‚Ä¶" autocomplete="off">
  <button onclick="send()">Send</button>
</div>

<input type="file" id="imgPicker" accept="image/*" hidden>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* üîí LOCK */
const ALLOWED_NAMES = ["haziq","kaunain"];
const CHAT_PASSWORD = "hnk123";

let username = localStorage.getItem("chat_name");
if(!username){
  username = prompt("Your name?");
  if(!ALLOWED_NAMES.includes(username.toLowerCase())){
    alert("Access denied");
    document.body.innerHTML="";
    throw "";
  }
  const pass = prompt("Password:");
  if(pass !== CHAT_PASSWORD){
    alert("Wrong password");
    document.body.innerHTML="";
    throw "";
  }
  localStorage.setItem("chat_name", username);
}

/* NOTIFICATIONS */
if("Notification" in window && Notification.permission!=="granted"){
  Notification.requestPermission();
}

/* COLOR */
function nameClass(n){
  n=n.toLowerCase();
  if(n==="haziq") return "blue";
  if(n==="kaunain") return "pink";
  return "";
}

/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyB0FpYJytVZuHjtHjL5-RDK1MlIEEi6K6c",
  authDomain:"private-chat-4f4b9.firebaseapp.com",
  projectId:"private-chat-4f4b9"
});
const db=firebase.firestore();

/* PRESENCE */
const presence=db.collection("presence");
function ping(){
  presence.doc(username).set({name:username,time:Date.now()});
}
setInterval(ping,2000); ping();

presence.onSnapshot(s=>{
  let now=Date.now();
  let h="offline",k="offline";
  s.forEach(d=>{
    let t=now-d.data().time;
    let n=d.data().name.toLowerCase();
    if(t<4000) (n==="haziq"?h:k)="online";
    else if(t<10000) (n==="haziq"?h:k)="idle";
  });
  setDot("dot-h",h);
  setDot("dot-k",k);
});

function setDot(id,state){
  let el=document.getElementById(id);
  el.classList.remove("online","idle");
  if(state==="online") el.classList.add("online");
  if(state==="idle") el.classList.add("idle");
}

/* SEND */
function send(){
  let t=msg.value.trim();
  if(!t) return;
  db.collection("messages").add({name:username,text:t,time:Date.now()});
  msg.value=""; msg.focus();
}

/* MEDIA */
function pickImage(){imgPicker.click();}
imgPicker.onchange=()=>{
  let f=imgPicker.files[0];
  if(!f)return;
  let r=new FileReader();
  r.onload=()=>db.collection("messages").add({name:username,image:r.result,time:Date.now()});
  r.readAsDataURL(f);
};

let rec,chunks=[],on=false;
async function toggleRecord(){
  if(on){rec.stop();on=false;return;}
  let s=await navigator.mediaDevices.getUserMedia({audio:true});
  rec=new MediaRecorder(s);chunks=[];
  rec.ondataavailable=e=>chunks.push(e.data);
  rec.onstop=()=>{
    let b=new Blob(chunks,{type:"audio/webm"});
    let r=new FileReader();
    r.onload=()=>db.collection("messages").add({name:username,audio:r.result,time:Date.now()});
    r.readAsDataURL(b);
  };
  rec.start(); on=true;
}

/* MESSAGES + NOTIFY */
db.collection("messages").orderBy("time").onSnapshot(s=>{
  chat.innerHTML="";
  s.forEach(d=>{
    let m=d.data();
    let b=document.createElement("div");
    b.className="msg"+(m.name===username?" me":"");
    let n=document.createElement("div");
    n.className="name "+nameClass(m.name);
    n.textContent=m.name;
    b.appendChild(n);
    if(m.text)b.appendChild(document.createTextNode(m.text));
    if(m.image){let i=document.createElement("img");i.src=m.image;b.appendChild(i);}
    if(m.audio){let a=document.createElement("audio");a.src=m.audio;a.controls=true;b.appendChild(a);}
    chat.appendChild(b);

    if(m.name!==username && document.hidden && Notification.permission==="granted"){
      new Notification(m.name,{body:"New message"});
    }
  });
  chat.scrollTop=chat.scrollHeight;
});
</script>

</body>
</html>
